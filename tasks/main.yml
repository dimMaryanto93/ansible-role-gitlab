---
# tasks file for ansible-role-gitlab-example
- name: Requirement & Prequisites to install Gitlab
  block: 
    - name: Install dependencies on Ubuntu
      include_tasks: ubuntu/prerequisite.yaml
      when: ansible_os_family == 'Debian'

- name: Install Gitlab package
  block: 
    - name: Check if GitLab configuration file already exists.
      stat: 
        path: /etc/gitlab/gitlab.rb
      register: gitlab_config_file

    - name: Check if GitLab is already installed.
      stat: 
        path: /usr/bin/gitlab-ctl
      register: gitlab_file

    - name: Install Gitlab on Ubuntu
      include_tasks: ubuntu/install.yaml
      when: ansible_os_family == 'Debian'

- name: Post Install Gitlab package
  block:
    - name: Reconfigure GitLab (first run).
      command: gitlab-ctl reconfigure
      failed_when: false

    - name: get info init root password for gitlab
      shell: "cat /etc/gitlab/initial_root_password | grep 'Password: ' | awk '{print $2}'"
      register: init_root_password
      when: gitlab_root_password_print

    - name: Debug root password
      debug: 
        msg: "{{ init_root_password.stdout }}"
      when: gitlab_root_password_print

- name: Firewall config allow gitlab access outside
  block:
    - name: UFW config
      include_tasks: ubuntu/ufw-cmd.yaml
      when: ansible_os_family == 'Debian'
